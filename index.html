<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>115å­¸å¹´åº¦ å‹åˆ©åœ‹ä¸­é©æ€§è¼”å°å®‰ç½® - å¿—é¡˜æ¨¡æ“¬ç³»çµ±</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
  /* --- åŸºç¤è¨­å®š --- */
  body { font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; background-color: #f4f7f6; margin: 0; padding: 20px; color: #333; line-height: 1.4; }
  .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.08); overflow-x: hidden; }

  /* æ¨™é¡Œ */
  h1 { text-align: center; color: #2c3e50; margin: 0 0 5px 0; font-size: 1.6em; font-weight: 800; }
  .badge-school { background-color: #34495e; color: #fff; padding: 5px 15px; border-radius: 50px; font-size: 0.6em; vertical-align: middle; margin-bottom: 5px; display: inline-block; letter-spacing: 1px; }
  .subtitle { text-align: center; color: #7f8c8d; font-size: 1em; margin-bottom: 20px; border-bottom: 3px solid #3498db; padding-bottom: 10px; font-weight: bold; }

  /* æ­¡è¿è© */
  .welcome-box { background-color: #fff8e1; border-left: 6px solid #ffb74d; padding: 15px 20px; margin-bottom: 25px; border-radius: 6px; }
  .welcome-title { font-weight: bold; color: #e65100; font-size: 1.1em; margin-bottom: 8px; display: block; }
  .welcome-list { margin: 0; padding-left: 20px; font-size: 0.95em; }
  .welcome-list li { margin-bottom: 4px; }

  /* å€å¡Š */
  .section { margin-bottom: 25px; padding: 20px; border: 1px solid #e0e0e0; border-radius: 10px; background: #fff; }
  h2 { font-size: 1.2em; color: #2c3e50; border-bottom: 1px solid #eee; padding-bottom: 8px; margin-top: 0; font-weight: bold; }

  /* è¼¸å…¥æ¡† */
  .input-row { display: flex; gap: 20px; flex-wrap: wrap; }
  .input-group { flex: 1; min-width: 250px; }
  label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
  input[type="text"] { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px; font-size: 1em; box-sizing: border-box; }

  /* è·ç¾¤æŒ‰éˆ• */
  .cluster-area { display: flex; flex-wrap: wrap; gap: 8px; }
  .c-btn { padding: 6px 14px; border: 1px solid #ccc; border-radius: 50px; cursor: pointer; background: #fff; transition: 0.2s; font-size: 0.95em; color: #555; }
  .c-btn.active { background: #2c3e50; color: #fff; border-color: #2c3e50; font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
  .c-btn.fourth { background: #e67e22; border-color: #d35400; color: white; }

  /* å¿—é¡˜æ±  & é¡è‰² */
  .pool-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 10px; }
  .btn-select-all { padding: 6px 15px; font-size: 0.9em; background: #34495e; color: white; border: none; border-radius: 20px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
  .btn-select-all:hover { background: #2c3e50; transform: translateY(-1px); }

  .pool-area { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 10px; max-height: 450px; overflow-y: auto; padding: 15px; background: #f9f9f9; border: 1px solid #ddd; border-radius: 8px; }
   
  /* è·ç¾¤é¡è‰²å®šç¾© */
  .bg-academic { background-color: #e3f2fd !important; border-left: 5px solid #2196f3; }
  .bg-machine { background-color: #e0f7fa !important; border-left: 5px solid #00bcd4; }
  .bg-power { background-color: #e8f5e9 !important; border-left: 5px solid #4caf50; }
  .bg-electro { background-color: #fffde7 !important; border-left: 5px solid #fbc02d; }
  .bg-business { background-color: #f3e5f5 !important; border-left: 5px solid #9c27b0; }
  .bg-design { background-color: #fce4ec !important; border-left: 5px solid #e91e63; }
  .bg-home { background-color: #f3e5f5 !important; border-left: 5px solid #673ab7; }
  .bg-hosp { background-color: #fff3e0 !important; border-left: 5px solid #ff9800; }
  .bg-food { background-color: #e0f2f1 !important; border-left: 5px solid #009688; }
  .bg-agri { background-color: #f1f8e9 !important; border-left: 5px solid #8bc34a; }
  .bg-service { background-color: #e8eaf6 !important; border-left: 5px solid #3f51b5; }
  .bg-chem { background-color: #e1f5fe !important; border-left: 5px solid #03a9f4; }

  .s-card { padding: 10px; border-radius: 6px; display: flex; align-items: center; cursor: pointer; border: 1px solid #eee; margin-bottom: 0; transition: 0.1s; }
  .s-card:hover { transform: translateY(-2px); box-shadow: 0 3px 6px rgba(0,0,0,0.1); }
  .s-card input { margin-right: 12px; transform: scale(1.5); cursor: pointer; pointer-events: none; }
  .s-card label { cursor: pointer; width: 100%; line-height: 1.25; font-size: 0.95em; pointer-events: none; }

  .count-display { display: inline-block; background: #eceff1; padding: 8px 20px; border-radius: 30px; font-weight: bold; color: #37474f; margin-top: 15px; font-size: 1em; border: 1px solid #cfd8dc; }

  /* æ’åºå€ */
  ul#sortList { padding: 0; list-style: none; margin: 0; }
  .sort-li { 
      padding: 10px 15px; margin-bottom: 10px; 
      background: #fff; border: 1px solid #ddd; border-radius: 8px; 
      display: flex; align-items: center; cursor: grab;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05); position: relative;
  }
  .sort-li:active { cursor: grabbing; background: #fafafa; }
  .sort-li.err-active { border: 2px solid #c0392b !important; background-color: #ffebee !important; }

  .idx-circle { 
      width: 30px; height: 30px; background: #34495e; color: #fff; 
      text-align: center; line-height: 30px; border-radius: 50%; 
      margin-right: 15px; font-size: 0.9em; font-weight: bold; flex-shrink: 0;
  }

  .info-block { flex-grow: 1; display: flex; flex-direction: column; }
  .info-top { font-size: 1.05em; font-weight: bold; color: #2c3e50; }
  .info-btm { font-size: 0.9em; color: #666; margin-top: 2px; }
   
  .tag { 
      display: inline-block; font-size: 0.8em; padding: 1px 6px; 
      border-radius: 4px; background-color: rgba(255,255,255,0.6); 
      border: 1px solid rgba(0,0,0,0.1); margin-left: 8px; vertical-align: text-top; color: #333;
  }

  .del-x { color: #bdbdbd; font-weight: bold; cursor: pointer; padding: 5px 10px; font-size: 1.4em; transition: 0.2s; margin-left: 10px; }
  .del-x:hover { color: #e74c3c; }

  /* æŒ‰éˆ• */
  .btn-zone { text-align: center; margin-top: 30px; }
  .btn { padding: 12px 25px; font-size: 1em; border: none; border-radius: 50px; cursor: pointer; color: white; font-weight: bold; margin: 5px; box-shadow: 0 4px 6px rgba(0,0,0,0.2); transition: transform 0.1s; }
  .btn:active { transform: scale(0.95); }
  .btn-main { background-color: #3498db; }
  .btn-save { background-color: #9b59b6; }
  .btn-dl { background-color: #27ae60; }
  .btn-copy { background-color: #f39c12; }
  .btn-back { background-color: #95a5a6; }
  .btn-clear { background-color: #e74c3c; }

  /* ------------------------------- */
  /* --- å ±è¡¨å€å¡Š (A4å¼·åˆ¶ç‰ˆé¢) --- */
  /* ------------------------------- */
  .report-scroll-wrapper { width: 100%; overflow-x: auto; padding-bottom: 20px; -webkit-overflow-scrolling: touch; }
  .scroll-hint { display: none; text-align: center; color: #7f8c8d; font-size: 0.85em; margin-top: -10px; margin-bottom: 10px; background: #f0f0f0; padding: 5px; border-radius: 15px; }
  @media (max-width: 800px) { .scroll-hint { display: block; } }

  #pageReport { 
      display: none; min-width: 850px; width: 850px; margin: 0 auto;
      border: 4px solid #34495e; padding: 40px; background: #fff; box-sizing: border-box;
  }

  table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.95em; }
  th, td { border: 1px solid #333; padding: 6px 8px; text-align: left; line-height: 1.3; white-space: nowrap; }
  th { background: #eceff1; text-align: center; font-weight: bold; }
   
  /* æ¬„ä½å¯¬åº¦èª¿æ•´ */
  .col-idx { width: 15%; text-align: center; }
  .col-cluster { width: 25%; text-align: center; }
  .col-school { width: 60%; text-align: left; }

  /* ç¸®å°çš„æ¨™ç±¤ */
  .badge-fourth {
      display: inline-block; background: #e67e22; color: white;
      padding: 1px 5px; border-radius: 4px; font-size: 0.65em;
      margin-left: 5px; vertical-align: text-bottom;
  }
   
  .sign-row { display: flex; justify-content: space-between; margin-top: 40px; gap: 50px; }
  .sign-col { flex: 1; border-top: 2px solid #333; padding-top: 10px; text-align: center; font-weight: bold; font-size: 1.1em; }

  .img-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
  .img-modal img { max-width: 95%; max-height: 80%; border: 2px solid #fff; border-radius: 8px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
  .modal-tip { color: #fff; font-size: 1.1em; margin-bottom: 15px; font-weight: bold; text-align: center; background: rgba(0,0,0,0.6); padding: 8px 20px; border-radius: 30px; }
  .modal-close { margin-top: 20px; padding: 10px 30px; background: #e74c3c; color: white; border: none; border-radius: 50px; font-size: 1.1em; cursor: pointer; font-weight: bold; }

  @media print {
    .no-print { display: none !important; }
    #pageForm { display: none !important; }
    .report-scroll-wrapper { overflow: visible !important; }
    #pageReport { display: block !important; border: none; padding: 0; margin: 0; width: 100%; min-width: 0; }
  }
</style>
</head>
<body>

<div class="container">
   
  <div id="pageForm">
    <h1><span class="badge-school">å‹åˆ©åœ‹ä¸­</span> 115å­¸å¹´åº¦ é©æ€§è¼”å°å®‰ç½®<br>å¿—é¡˜é¸å¡«æ¨¡æ“¬ç³»çµ±</h1>
    <div class="subtitle">åŒ…å«æ–°ç«¹ç¸£/å¸‚æ‰€æœ‰æ ¡ç³» â€¢ ä¾æ“š115å­¸å¹´åº¦æœ€æ–°å¿—é¡˜è¡¨æ›´æ–°</div>
    
    <div class="welcome-box">
      <span class="welcome-title">ğŸ‘‹ å„ä½å®¶é•·èˆ‡åŒå­¸å¥½ï¼Œè«‹ç•™æ„ä»¥ä¸‹é¸å¡«è¦å‰‡ï¼š</span>
      <ul class="welcome-list">
        <li>æœ¬ç³»çµ±ç‚º<strong>å‹åˆ©åœ‹ä¸­æ¨¡æ“¬ç·´ç¿’ç”¨</strong>ï¼Œå¯¦éš›åé¡ä»¥ç°¡ç« ç‚ºæº–ã€‚</li>
        <li>è«‹ä¾åºé¸å¡«<strong>è‡³å°‘ 15 å€‹</strong>å¿—é¡˜ã€‚(è‹¥å¯é¸å¿—é¡˜ç¸½æ•¸ä¸è¶³15å€‹ï¼Œè«‹<strong>å…¨éƒ¨å‹¾é¸</strong>)ã€‚</li>
        <li><strong>å‰ 3 å€‹å¿—é¡˜</strong>åŸå‰‡ä¸Šé ˆç‚ºã€Œ<strong>åŒä¸€è·ç¾¤</strong>ã€ã€‚<br>
            <span style="color:#e65100; font-size:0.9em;">(è¨»ï¼šè‹¥è©²ç¾¤åƒ…1å€‹å¿—é¡˜ï¼Œå‰‡2ã€3å¿—é¡˜éœ€åŒç¾¤ï¼›è‹¥è©²ç¾¤åƒ…2å€‹ï¼Œå‰‡å‰2å¿—é¡˜éœ€å¡«æ»¿)</span>
        </li>
        <li>è‹¥å·²é¸ 3 å€‹è·ç¾¤ä½†ç¸½åé¡ä¸è¶³ 10 å€‹ï¼Œå¯åŠ é¸ç¬¬ 4 å€‹è·ç¾¤ã€‚</li>
        <li><strong>æ³¨æ„ï¼šåŠ é¸çš„ç¬¬ 4 è·ç¾¤å¿—é¡˜ï¼Œæ’åºæ™‚ä¸å¯ç§»å‹•è‡³å‰ 3 è·ç¾¤å€åŸŸå…§ã€‚</strong></li>
        <li>æœ¬ç³»çµ±æœƒ<strong>è‡ªå‹•å„²å­˜</strong>æ‚¨çš„é€²åº¦ï¼Œè‹¥éœ€å¹«å¦ä¸€ä½åŒå­¸é¸å¡«ï¼Œè«‹é»é¸ã€Œæ¸…ç©ºé‡å¡«ã€ã€‚</li>
      </ul>
    </div>

    <div class="section">
      <h2>1. åŸºæœ¬è³‡æ–™</h2>
      <div class="input-row">
        <div class="input-group"><label>å­¸ç”Ÿå§“åï¼š</label><input type="text" id="inpStudent" oninput="saveToLocalStorage()"></div>
        <div class="input-group"><label>å®¶é•·å§“åï¼š</label><input type="text" id="inpParent" oninput="saveToLocalStorage()"></div>
      </div>
    </div>

    <div class="section">
      <h2>2. é¸æ“‡è·ç¾¤</h2>
      <div id="msgCluster" style="color:#2980b9; display:none; margin-bottom:10px; font-weight:bold;"></div>
      <div class="cluster-area" id="divClusters"></div>
      <p style="margin-top:10px; color:#666; font-size:0.9em;">ç›®å‰å·²é¸ï¼š<strong id="txtClusterCount" style="color:#e74c3c;">0</strong> å€‹è·ç¾¤</p>
    </div>

    <div class="section">
      <h2>3. å‹¾é¸å¿—é¡˜ (è«‹è‡³å°‘é¸ 15 å€‹ï¼Œè‹¥ä¸è¶³å‰‡å…¨é¸)</h2>
      <div class="pool-header">
          <span style="font-size:0.9em;color:#555;">é»é¸ä¸‹æ–¹å¡ç‰‡åŠ å…¥æ¸…å–®</span>
          <button class="btn-select-all" onclick="window.appSelectAll()">âœ… å…¨é¸æœ¬å€</button>
      </div>
      <div class="pool-area" id="divPool">è«‹å…ˆåœ¨ä¸Šæ–¹é»é¸è·ç¾¤...</div>
      <div style="text-align:right;">
        <div class="count-display">
          å·²å‹¾é¸ <span id="txtSel" style="color:#27ae60;">0</span> å€‹ / 
          æœ¬å€å…± <span id="txtTotal" style="color:#2980b9;">0</span> å€‹å¯é¸
        </div>
      </div>
    </div>

    <div class="section">
      <h2>4. å¿—é¡˜æ’åº (è«‹æŒ‰ä½æ‹–æ›³)</h2>
      <div id="msgError" style="background:#ffebee; color:#c62828; padding:10px; border:1px solid #ef9a9a; border-radius:5px; display:none; font-weight:bold; margin-bottom:10px;"></div>
      <ul id="sortList"></ul>
    </div>

    <div class="btn-zone">
      <button type="button" class="btn btn-main" onclick="window.appGenerateReport()">ç”¢ç”Ÿç¢ºèªè¡¨</button>
      <button type="button" class="btn btn-clear" onclick="window.appClearAll()">æ¸…ç©ºé‡å¡«</button>
    </div>
  </div>

  <div id="reportContainer" style="display:none;">
      <div class="scroll-hint">ğŸ’¡ è«‹å·¦å³æ»‘å‹•æª¢æŸ¥å ±è¡¨å®Œæ•´æ€§</div>
      <div class="report-scroll-wrapper">
          <div id="pageReport">
            <h2 style="text-align:center; border:none; margin-bottom:15px; font-size:1.5em;">115å­¸å¹´åº¦ é©æ€§è¼”å°å®‰ç½®<br>å¿—é¡˜é¸å¡«ç¢ºèªè¡¨ (å‹åˆ©åœ‹ä¸­æ¨¡æ“¬)</h2>
            
            <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-size:1.05em; border-bottom:2px solid #eee; padding-bottom:10px;">
              <div>å­¸ç”Ÿï¼š<strong id="outStudent"></strong></div>
              <div>å®¶é•·ï¼š<strong id="outParent"></strong></div>
              <div>æ—¥æœŸï¼š<span id="outDate"></span></div>
            </div>
            
            <div style="margin-bottom:10px; font-size:1em;"><strong>ã€å·²é¸è·ç¾¤ã€‘ï¼š</strong><span id="outClusters"></span></div>
            
            <table style="width:100%; border-collapse:collapse;">
              <thead>
                <tr>
                  <th class="col-idx">åº</th>
                  <th class="col-cluster">è·ç¾¤</th>
                  <th class="col-school">å­¸æ ¡ / ç§‘åˆ¥</th>
                </tr>
              </thead>
              <tbody id="rptBody"></tbody>
            </table>

            <div class="sign-row">
              <div class="sign-col">å®¶é•·ç°½å<br><span style="font-size:0.8em; color:#999; font-weight:normal;">(è«‹åœ¨æ­¤è™•ç°½å)</span></div>
              <div class="sign-col">å­¸ç¿’ä¸­å¿ƒè€å¸«<br><span style="font-size:0.8em; color:#999; font-weight:normal;">(è«‹åœ¨æ­¤è™•ç°½å/æ ¸ç« )</span></div>
            </div>
          </div>
      </div>

      <div class="btn-zone no-print" style="margin-top:20px; padding-bottom:40px;">
        <button type="button" class="btn btn-save" onclick="window.appSaveImage()">å­˜æˆåœ–ç‰‡</button>
        <button type="button" class="btn btn-copy" onclick="window.appCopyTxt()">ğŸ“‹ è¤‡è£½å…§å®¹</button>
        <button type="button" class="btn btn-dl" onclick="window.appDownloadTxt()">ä¸‹è¼‰æ–‡å­—æª”</button>
        <button type="button" class="btn btn-back" onclick="window.appGoBack()">è¿”å›ä¿®æ”¹</button>
      </div>
  </div>

</div>

<script>
    // ==========================================
    // 1. è³‡æ–™åº« (115å­¸å¹´åº¦ å‹åˆ©åœ‹ä¸­é©æ€§è¼”å°å®‰ç½® - åœ–ç‰‡æ›´æ–°ç‰ˆ)
    // ==========================================
    const DB = [
        {
            c: "åŒ–å·¥ç¾¤", 
            cls: "bg-chem", 
            list: [
                {s:"ç¸£ç«‹è‡ªå¼·é«˜å·¥", d:"åŒ–å·¥ç§‘"},
                {s:"åœ‹ç«‹æ–°ç«¹é«˜å·¥", d:"åŒ–å·¥ç§‘"}
            ]
        },
        {
            c: "å¤–èªç¾¤", 
            cls: "bg-service", 
            list: [
                {s:"ç§ç«‹å…‰å¾©é«˜ä¸­", d:"æ‡‰ç”¨æ—¥èªç§‘"},
                {s:"ç§ç«‹å…‰å¾©é«˜ä¸­", d:"æ‡‰ç”¨è‹±èªç§‘"},
                {s:"åœ‹ç«‹æ–°ç«¹é«˜å•†", d:"æ‡‰ç”¨è‹±èªç§‘"},
                {s:"ç§ç«‹æ›™å…‰å¥³ä¸­", d:"æ‡‰ç”¨æ—¥èªç§‘ (é™å¥³ç”Ÿ)"},
                {s:"ç§ç«‹æ›™å…‰å¥³ä¸­", d:"æ‡‰ç”¨è‹±èªç§‘ (é™å¥³ç”Ÿ)"}
            ]
        },
        {
            c: "é£Ÿå“ç¾¤", 
            cls: "bg-food", 
            list: [
                {s:"åœ‹ç«‹é—œè¥¿é«˜ä¸­", d:"é£Ÿå“åŠ å·¥ç§‘"}
            ]
        },
        {
            c: "å®¶æ”¿ç¾¤", 
            cls: "bg-home", 
            list: [
                {s:"ç§ç«‹ä»°å¾·é«˜ä¸­", d:"æ™‚å°šé€ å‹ç§‘"},
                {s:"ç§ç«‹æ±æ³°é«˜ä¸­", d:"æ™‚å°šé€ å‹ç§‘"},
                {s:"ç§ç«‹ç¾©æ°‘é«˜ä¸­", d:"å¹¼å…’ä¿è‚²ç§‘"},
                {s:"åœ‹ç«‹é—œè¥¿é«˜ä¸­", d:"å®¶æ”¿ç§‘"},
                {s:"ç§ç«‹å…‰å¾©é«˜ä¸­", d:"å¹¼å…’ä¿è‚²ç§‘"},
                {s:"ç§ç«‹å…‰å¾©é«˜ä¸­", d:"æ™‚å°šé€ å‹ç§‘"},
                {s:"ç§ç«‹å…‰å¾©é«˜ä¸­", d:"ç…§é¡§æœå‹™ç§‘"}
            ]
        },
        {
            c: "å‹•åŠ›æ©Ÿæ¢°ç¾¤", 
            cls: "bg-power", 
            list: [
                {s:"ç§ç«‹æ±æ³°é«˜ä¸­", d:"æ±½è»Šç§‘"},
                {s:"ç§ç«‹å…‰å¾©é«˜ä¸­", d:"æ±½è»Šç§‘"}
            ]
        },
        {
            c: "å•†æ¥­ç¾¤", 
            cls: "bg-business", 
            list: [
                {s:"ç§ç«‹ç¾©æ°‘é«˜ä¸­", d:"å•†ç”¨è³‡è¨Šç§‘ (å¯¦ç”¨æŠ€èƒ½å­¸ç¨‹)"},
                {s:"åœ‹ç«‹æ–°ç«¹é«˜å•†", d:"éŠ·å”®äº‹å‹™ç§‘ (å¯¦ç”¨æŠ€èƒ½å­¸ç¨‹)"},
                {s:"åœ‹ç«‹æ–°ç«¹é«˜å•†", d:"å•†ç”¨è³‡è¨Šç§‘ (å¯¦ç”¨æŠ€èƒ½å­¸ç¨‹)"},
               ]
        },
        {
            c: "å•†æ¥­èˆ‡ç®¡ç†ç¾¤", 
            cls: "bg-business", 
            list: [
                {s:"ç§ç«‹ç¾©æ°‘é«˜ä¸­", d:"å•†ç”¨è³‡è¨Šç§‘ (å¯¦ç”¨æŠ€èƒ½å­¸ç¨‹)"},
                {s:"åœ‹ç«‹æ–°ç«¹é«˜å•†", d:"éŠ·å”®äº‹å‹™ç§‘ (å¯¦ç”¨æŠ€èƒ½å­¸ç¨‹)"},
                {s:"åœ‹ç«‹æ–°ç«¹é«˜å•†", d:"å•†ç”¨è³‡è¨Šç§‘ (å¯¦ç”¨æŠ€èƒ½å­¸ç¨‹)"},
                {s:"ç§ç«‹ä»°å¾·é«˜ä¸­", d:"é›»å­å•†å‹™ç§‘"},
                {s:"ç§ç«‹æ±æ³°é«˜ä¸­", d:"è³‡æ–™è™•ç†ç§‘"},
                {s:"ç¸£ç«‹æ¹–å£é«˜ä¸­", d:"å•†æ¥­ç¶“ç‡Ÿç§‘"},
                {s:"åœ‹ç«‹é™½æ˜äº¤å¤§é™„ä¸­", d:"å•†æ¥­ç¶“ç‡Ÿç§‘"},
                {s:"ç§ç«‹ç¾©æ°‘é«˜ä¸­", d:"è³‡æ–™è™•ç†ç§‘"},
                {s:"åœ‹ç«‹é—œè¥¿é«˜ä¸­", d:"å•†æ¥­ç¶“ç‡Ÿç§‘"},
                {s:"ç§ç«‹å…‰å¾©é«˜ä¸­", d:"è³‡æ–™è™•ç†ç§‘"},
                {s:"å¸‚ç«‹é¦™å±±é«˜ä¸­", d:"è³‡æ–™è™•ç†ç§‘"},
                {s:"åœ‹ç«‹æ–°ç«¹é«˜å•†", d:"å•†æ¥­ç¶“ç‡Ÿç§‘"},
                {s:"åœ‹ç«‹æ–°ç«¹é«˜å•†", d:"åœ‹éš›è²¿æ˜“ç§‘"},
                {s:"åœ‹ç«‹æ–°ç«¹é«˜å•†", d:"è³‡æ–™è™•ç†ç§‘"},
                {s:"ç§ç«‹ç£çŸ³é«˜ä¸­", d:"è³‡æ–™è™•ç†ç§‘"},
                {s:"ç§ç«‹æ›™å…‰å¥³ä¸­", d:"å•†æ¥­ç¶“ç‡Ÿç§‘ (é™å¥³ç”Ÿ)"}
            ]
        },
        {
            c: "è¨­è¨ˆç¾¤", 
            cls: "bg-design", 
            list: [
                {s:"ç§ç«‹å…§æ€é«˜ä¸­", d:"å¤šåª’é«”è¨­è¨ˆç§‘"},
                {s:"ç§ç«‹ç¾©æ°‘é«˜ä¸­", d:"å»£å‘ŠæŠ€è¡“ç§‘ (å¯¦ç”¨æŠ€èƒ½å­¸ç¨‹)"},
                {s:"ç§ç«‹ç¾©æ°‘é«˜ä¸­", d:"å»£å‘Šè¨­è¨ˆç§‘"},
                {s:"ç§ç«‹å…‰å¾©é«˜ä¸­", d:"å®¤å…§è¨­è¨ˆç§‘"},
                {s:"ç§ç«‹å…‰å¾©é«˜ä¸­", d:"å»£å‘Šè¨­è¨ˆç§‘"},
                {s:"ç§ç«‹å…‰å¾©é«˜ä¸­", d:"å¤šåª’é«”è¨­è¨ˆç§‘"},
                {s:"å¸‚ç«‹é¦™å±±é«˜ä¸­", d:"ç¾è¡“å·¥è—ç§‘"},
                {s:"åœ‹ç«‹æ–°ç«¹é«˜å·¥", d:"å®¤å…§ç©ºé–“è¨­è¨ˆç§‘"}
            ]
        },
        {
            c: "è¾²æ¥­ç¾¤", 
            cls: "bg-agri", 
            list: [
                {s:"åœ‹ç«‹é—œè¥¿é«˜ä¸­", d:"åœ’è—ç§‘"},
                {s:"åœ‹ç«‹é—œè¥¿é«˜ä¸­", d:"ç•œç”¢ä¿å¥ç§‘"}
            ]
        },
        {
            c: "é›»æ©Ÿèˆ‡é›»å­ç¾¤", 
            cls: "bg-electro", 
            list: [
                {s:"ç§ç«‹å…§æ€é«˜ä¸­", d:"è³‡è¨Šç§‘"},
                {s:"ç§ç«‹å…§æ€é«˜ä¸­", d:"é›»å­ç§‘"},
                {s:"ç§ç«‹å…§æ€é«˜ä¸­", d:"é›»æ©Ÿç§‘"},
                {s:"ç¸£ç«‹è‡ªå¼·é«˜å·¥", d:"è³‡è¨Šç§‘"},
                {s:"ç¸£ç«‹è‡ªå¼·é«˜å·¥", d:"é›»å­ç§‘"},
                {s:"ç§ç«‹æ±æ³°é«˜ä¸­", d:"æ°´é›»æŠ€è¡“ç§‘ (å¯¦ç”¨æŠ€èƒ½å­¸ç¨‹)"},
                {s:"åœ‹ç«‹é™½æ˜äº¤å¤§é™„ä¸­", d:"è³‡è¨Šç§‘"},
                {s:"ç§ç«‹ç¾©æ°‘é«˜ä¸­", d:"è³‡è¨Šç§‘"},
                {s:"ç§ç«‹å…‰å¾©é«˜ä¸­", d:"è³‡è¨Šç§‘"},
                {s:"ç§ç«‹å…‰å¾©é«˜ä¸­", d:"é›»å­ç§‘"},
                {s:"ç§ç«‹å…‰å¾©é«˜ä¸­", d:"é›»æ©Ÿç§‘"},
                {s:"åœ‹ç«‹æ–°ç«¹é«˜å·¥", d:"è³‡è¨Šç§‘"},
                {s:"åœ‹ç«‹æ–°ç«¹é«˜å·¥", d:"é›»æ©Ÿç§‘"},
                {s:"ç§ç«‹ç£çŸ³é«˜ä¸­", d:"é›»æ©Ÿç§‘"},
                {s:"åœ‹ç«‹é—œè¥¿é«˜ä¸­", d:"é›»æ©Ÿç§‘"}
            ]
        },
        {
            c: "å­¸è¡“ç¾¤", 
            cls: "bg-academic", 
            list: [
                {s:"ç§ç«‹å…§æ€é«˜ä¸­", d:"ç¶œåˆé«˜ä¸­"},
                {s:"ç¸£ç«‹å…­å®¶é«˜ä¸­", d:"æ™®é€šç§‘"},
                {s:"åœ‹ç«‹ç«¹æ±é«˜ä¸­", d:"æ™®é€šç§‘"},
                {s:"ç§ç«‹å¿ ä¿¡é«˜ä¸­", d:"æ™®é€šç§‘"},
                {s:"ç§ç«‹å¿ ä¿¡é«˜ä¸­", d:"ç¶œåˆé«˜ä¸­"},
                {s:"ç§ç«‹æ±æ³°é«˜ä¸­", d:"æ™®é€šç§‘"},
                {s:"ç¸£ç«‹æ¹–å£é«˜ä¸­", d:"æ™®é€šç§‘"},
                {s:"åœ‹ç«‹é™½æ˜äº¤å¤§é™„ä¸­", d:"æ™®é€šç§‘"},
                {s:"ç§ç«‹ç¾©æ°‘é«˜ä¸­", d:"æ™®é€šç§‘"},
                {s:"åœ‹ç«‹é—œè¥¿é«˜ä¸­", d:"æ™®é€šç§‘"},
                {s:"ç§ç«‹å…‰å¾©é«˜ä¸­", d:"æ™®é€šç§‘"},
                {s:"å¸‚ç«‹æˆå¾·é«˜ä¸­", d:"æ™®é€šç§‘"},
                {s:"åœ‹ç«‹ç«¹ç§‘å¯¦ä¸­", d:"æ™®é€šç§‘"},
                {s:"å¸‚ç«‹å»ºåŠŸé«˜ä¸­", d:"æ™®é€šç§‘"},
                {s:"å¸‚ç«‹é¦™å±±é«˜ä¸­", d:"æ™®é€šç§‘"},
                {s:"åœ‹ç«‹æ–°ç«¹å¥³ä¸­", d:"æ™®é€šç§‘ (é™å¥³ç”Ÿ)"},
                {s:"åœ‹ç«‹æ–°ç«¹é«˜ä¸­", d:"æ™®é€šç§‘ (é™ç”·ç”Ÿ)"},
                {s:"åœ‹ç«‹æ–°ç«¹é«˜å•†", d:"ç¶œåˆé«˜ä¸­"},
                {s:"ç§ç«‹ç£çŸ³é«˜ä¸­", d:"æ™®é€šç§‘"},
                {s:"ç§ç«‹æ›™å…‰å¥³ä¸­", d:"æ™®é€šç§‘ (é™å¥³ç”Ÿ)"}
            ]
        },
        {
            c: "æ©Ÿæ¢°ç¾¤", 
            cls: "bg-machine", 
            list: [
                {s:"ç§ç«‹å…§æ€é«˜ä¸­", d:"æ©Ÿæ¢°ç§‘"},
                {s:"åœ‹ç«‹æ–°ç«¹é«˜å·¥", d:"æ¿é‡‘ç§‘"},
                {s:"åœ‹ç«‹æ–°ç«¹é«˜å·¥", d:"è£½åœ–ç§‘"},
                {s:"åœ‹ç«‹æ–°ç«¹é«˜å·¥", d:"æ©Ÿæ¢°ç§‘"},
                {s:"åœ‹ç«‹æ–°ç«¹é«˜å·¥", d:"æ©Ÿæ¢°åŠ å·¥ç§‘ (å¯¦ç”¨æŠ€èƒ½å­¸ç¨‹)"},
                {s:"ç§ç«‹ç£çŸ³é«˜ä¸­", d:"æ©Ÿæ¢°ç§‘"}
            ]
        },
        {
            c: "é¤æ—…ç¾¤", 
            cls: "bg-hosp", 
            list: [
                {s:"ç§ç«‹ä»°å¾·é«˜ä¸­", d:"çƒ˜ç„™é£Ÿå“ç§‘ (å¯¦ç”¨æŠ€èƒ½å­¸ç¨‹)"},
                {s:"ç§ç«‹ä»°å¾·é«˜ä¸­", d:"é¤é£²æŠ€è¡“ç§‘ (å¯¦ç”¨æŠ€èƒ½å­¸ç¨‹)"},
                {s:"ç§ç«‹ä»°å¾·é«˜ä¸­", d:"é¤é£²ç®¡ç†ç§‘"},
                {s:"ç§ç«‹æ±æ³°é«˜ä¸­", d:"é¤é£²æŠ€è¡“ç§‘ (å¯¦ç”¨æŠ€èƒ½å­¸ç¨‹)"},
                {s:"ç§ç«‹æ±æ³°é«˜ä¸­", d:"é¤é£²ç®¡ç†ç§‘"},
                {s:"åœ‹ç«‹é—œè¥¿é«˜ä¸­", d:"é¤é£²ç®¡ç†ç§‘"},
                {s:"ç§ç«‹å…‰å¾©é«˜ä¸­", d:"é¤é£²ç®¡ç†ç§‘"}
            ]
        }
    ];

    let state = { clusters: [], wishes: [], fourth: null, counts: {} };

    // --- åˆå§‹åŒ– ---
    (function init() {
        DB.forEach(g => { state.counts[g.c] = g.list.length; });
        
        // å¾ LocalStorage è¼‰å…¥è³‡æ–™
        loadFromLocalStorage();
        
        renderClusters();
        renderPool();
        renderSortList();
        initSortable();
    })();

    // --- LocalStorage æ ¸å¿ƒé‚è¼¯ ---
    function saveToLocalStorage() {
        const dataToSave = {
            student: document.getElementById('inpStudent').value,
            parent: document.getElementById('inpParent').value,
            clusters: state.clusters,
            wishes: state.wishes,
            fourth: state.fourth
        };
        // æ›´æ–° Key é¿å…èˆ‡èˆŠè³‡æ–™æ··æ·†
        localStorage.setItem('vsm_sim_data_115_image_update', JSON.stringify(dataToSave));
    }

    function loadFromLocalStorage() {
        const savedData = localStorage.getItem('vsm_sim_data_115_image_update');
        if (savedData) {
            try {
                const parsed = JSON.parse(savedData);
                document.getElementById('inpStudent').value = parsed.student || "";
                document.getElementById('inpParent').value = parsed.parent || "";
                state.clusters = parsed.clusters || [];
                state.wishes = parsed.wishes || [];
                state.fourth = parsed.fourth || null;
            } catch (e) {
                console.error("è¼‰å…¥å¿«å–å¤±æ•—", e);
            }
        }
    }

    window.appClearAll = function() {
        if (confirm("é€™å°‡æ¸…ç©ºæ‰€æœ‰å·²é¸å¡«çš„å¿—é¡˜èˆ‡å§“åï¼Œç¢ºå®šå—ï¼Ÿ")) {
            localStorage.removeItem('vsm_sim_data_115_image_update');
            location.reload();
        }
    };

    // --- è·ç¾¤é‚è¼¯ ---
    function renderClusters() {
        const div = document.getElementById('divClusters');
        div.innerHTML = '';
        DB.forEach(g => {
            const btn = document.createElement('div');
            btn.className = 'c-btn';
            btn.innerText = g.c;
            if (state.clusters.includes(g.c)) {
                btn.classList.add('active');
                if (g.c === state.fourth) btn.classList.add('fourth');
            }
            btn.onclick = () => toggleCluster(g.c);
            div.appendChild(btn);
        });

        document.getElementById('txtClusterCount').innerText = state.clusters.length;
        const msg = document.getElementById('msgCluster');
        let top3Count = 0;
        state.clusters.forEach(c => { if (c !== state.fourth) top3Count += state.counts[c]; });

        if (state.clusters.length === 3 && top3Count < 10) {
            msg.style.display = 'block';
            msg.innerText = `âš ï¸ é¸å– 3 å€‹è·ç¾¤ç¸½é¡åƒ… ${top3Count} å€‹ (å°‘æ–¼10å€‹)ï¼Œå¯åŠ é¸ç¬¬ 4 ç¾¤ï¼`;
        } else if (state.clusters.length === 4) {
            msg.style.display = 'block';
            msg.innerText = `âœ… å·²åŠ é¸ç¬¬ 4 è·ç¾¤ï¼š${state.fourth}`;
        } else {
            msg.style.display = 'none';
        }
    }

    function toggleCluster(cName) {
        if (state.clusters.includes(cName)) {
            // [UXå®‰å…¨] å¦‚æœè©²è·ç¾¤å·²æœ‰å¿—é¡˜ï¼Œè·³å‡ºè­¦å‘Š
            if (state.wishes.some(w => w.c === cName)) {
                if (!confirm(`æ‚¨åœ¨ã€Œ${cName}ã€å·²ç¶“é¸äº†å¿—é¡˜ã€‚\nå–æ¶ˆæ­¤è·ç¾¤å°‡æœƒã€Œåˆªé™¤ã€é€™äº›å¿—é¡˜æ’åºï¼Œç¢ºå®šå—ï¼Ÿ`)) {
                    return;
                }
            }

            state.clusters = state.clusters.filter(c => c !== cName);
            if (cName === state.fourth) state.fourth = null;
            state.wishes = state.wishes.filter(w => w.c !== cName);
            if (state.clusters.length <= 3) state.fourth = null;
        } else {
            if (state.clusters.length < 3) {
                state.clusters.push(cName);
            } else if (state.clusters.length === 3) {
                let currentTotal = 0;
                state.clusters.forEach(c => currentTotal += state.counts[c]);
                if (currentTotal < 10) {
                    state.clusters.push(cName);
                    state.fourth = cName;
                } else {
                    alert("å·²é¸ 3 å€‹è·ç¾¤ä¸”åé¡å……è¶³ï¼Œä¸å¯åŠ é¸ï¼");
                    return;
                }
            } else {
                alert("æœ€å¤šåƒ…èƒ½é¸æ“‡ 4 å€‹è·ç¾¤ï¼");
                return;
            }
        }
        renderClusters();
        renderPool();
        renderSortList();
        saveToLocalStorage();
    }

    // --- å¿—é¡˜æ± é‚è¼¯ ---
    function renderPool() {
        const pool = document.getElementById('divPool');
        pool.innerHTML = '';
        let totalOpts = 0;

        if (state.clusters.length === 0) {
            pool.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:20px; color:#888;">è«‹å…ˆåœ¨ä¸Šæ–¹é»é¸è·ç¾¤...</div>';
            updateStats(0, 0);
            return;
        }

        state.clusters.forEach(cName => {
            const grp = DB.find(g => g.c === cName);
            if (!grp) return;
            totalOpts += grp.list.length;

            grp.list.forEach(item => {
                const uid = `${cName}-${item.s}-${item.d}`;
                const isSelected = state.wishes.some(w => w.uid === uid);
                const is4 = (cName === state.fourth);

                const card = document.createElement('div');
                card.className = `s-card ${grp.cls}`;
                if (is4) card.style.border = '2px dashed #e67e22';

                const chk = document.createElement('input');
                chk.type = 'checkbox';
                chk.checked = isSelected;
                
                const lbl = document.createElement('label');
                const badge = is4 ? ' <span style="color:#d35400;font-size:0.8em;font-weight:bold;">(åŠ é¸)</span>' : '';
                lbl.innerHTML = `<strong>${item.s}</strong>${badge}<br>${item.d} <span style="font-size:0.85em;color:#666;">(${cName})</span>`;

                const toggle = () => {
                    const idx = state.wishes.findIndex(w => w.uid === uid);
                    if (idx > -1) {
                        state.wishes.splice(idx, 1);
                    } else {
                        state.wishes.push({uid, s:item.s, d:item.d, c:cName, cls:grp.cls, is4});
                        // æ–°å¢æ™‚è‡ªå‹•åˆ†å€æ’åº (é4åœ¨å‰, 4åœ¨å¾Œ)
                        state.wishes.sort((a, b) => {
                            if (a.is4 === b.is4) return 0;
                            return a.is4 ? 1 : -1;
                        });
                    }
                    renderPool();
                    renderSortList();
                    saveToLocalStorage();
                };

                card.onclick = (e) => { if (e.target.tagName !== 'INPUT') toggle(); };
                
                card.appendChild(chk);
                card.appendChild(lbl);
                pool.appendChild(card);
            });
        });
        updateStats(state.wishes.length, totalOpts);
    }

    window.appSelectAll = function() {
        if (state.clusters.length === 0) return;
        let hasNew = false;
        state.clusters.forEach(cName => {
            const grp = DB.find(g => g.c === cName);
            if (!grp) return;
            const is4 = (cName === state.fourth);
            grp.list.forEach(item => {
                const uid = `${cName}-${item.s}-${item.d}`;
                if (!state.wishes.some(w => w.uid === uid)) {
                    state.wishes.push({uid, s:item.s, d:item.d, c:cName, cls:grp.cls, is4});
                    hasNew = true;
                }
            });
        });

        if(hasNew) {
            state.wishes.sort((a, b) => {
                if (a.is4 === b.is4) return 0;
                return a.is4 ? 1 : -1;
            });
            renderPool();
            renderSortList();
            saveToLocalStorage();
        }
    };

    function updateStats(sel, total) {
        document.getElementById('txtSel').innerText = sel;
        document.getElementById('txtTotal').innerText = total;
        state.currentTotalAvailable = total;
    }

    // --- æ’åºå€ ---
    function renderSortList() {
        const list = document.getElementById('sortList');
        list.innerHTML = '';
        state.wishes.forEach((w, idx) => {
            const li = document.createElement('li');
            li.className = `sort-li ${w.cls}`;
            li.setAttribute('data-uid', w.uid);
            if (w.is4) {
                li.classList.add('is-fourth-item');
                li.style.border = '2px dashed #e67e22';
            }

            const tag4 = w.is4 ? '<span class="tag" style="background:#ffecb3;color:#d35400">ç¬¬4è·ç¾¤</span>' : '';
            li.innerHTML = `
                <div class="idx-circle">${idx + 1}</div>
                <div class="info-block">
                    <div class="info-top">${w.s}</div>
                    <div class="info-btm">${w.d} <span class="tag">${w.c}</span>${tag4}</div>
                </div>
                <div class="del-x">âœ•</div>
            `;
            li.querySelector('.del-x').onclick = () => {
                state.wishes = state.wishes.filter(x => x.uid !== w.uid);
                renderPool();
                renderSortList();
                saveToLocalStorage();
            };
            list.appendChild(li);
        });
        validateRules();
    }

    function initSortable() {
        const el = document.getElementById('sortList');
        let check = setInterval(() => {
            if (typeof Sortable !== 'undefined') {
                clearInterval(check);
                Sortable.create(el, {
                    animation: 150,
                    onMove: function (evt) {
                        var draggedItem = evt.dragged;
                        var targetItem = evt.related;
                        var isDraggedFourth = draggedItem.classList.contains('is-fourth-item');
                        var isTargetFourth = targetItem.classList.contains('is-fourth-item');
                        if (isDraggedFourth && !isTargetFourth) return false;
                        if (!isDraggedFourth && isTargetFourth) return false;
                        return true;
                    },
                    onEnd: () => {
                        const newOrderIds = Array.from(el.children).map(li => li.getAttribute('data-uid'));
                        const newWishes = [];
                        newOrderIds.forEach(uid => {
                            const found = state.wishes.find(w => w.uid === uid);
                            if (found) newWishes.push(found);
                        });
                        state.wishes = newWishes;
                        renderSortList();
                        saveToLocalStorage();
                    }
                });
            }
        }, 500);
    }

    function validateRules() {
        const errBox = document.getElementById('msgError');
        const items = document.querySelectorAll('.sort-li');
        items.forEach(i => i.classList.remove('err-active'));
        errBox.style.display = 'none';

        if (state.wishes.length === 0) return true;

        let fail = false;
        let msg = '';
        const c1 = state.wishes[0].c;
        const limit = state.counts[c1] || 10;

        if (limit >= 3) {
            if (state.wishes.length >= 3 && (state.wishes[1].c !== c1 || state.wishes[2].c !== c1)) {
                fail = true; msg = `âš ï¸ ç¬¬ 1 å¿—é¡˜ã€Œ${c1}ã€åé¡å……è¶³ï¼Œå‰ 3 å¿—é¡˜é ˆç‚ºåŒä¸€è·ç¾¤ï¼`;
                if(items[0]) items[0].classList.add('err-active');
                if(items[1]) items[1].classList.add('err-active');
                if(items[2]) items[2].classList.add('err-active');
            }
        } else if (limit === 2) {
            if (state.wishes.length >= 2 && state.wishes[1].c !== c1) {
                fail = true; msg = `âš ï¸ ç¬¬ 1 å¿—é¡˜ã€Œ${c1}ã€åƒ… 2 å€‹åé¡ï¼Œå‰ 2 å¿—é¡˜é ˆå¡«æ»¿ï¼`;
                items[0].classList.add('err-active');
                items[1].classList.add('err-active');
            }
        } else if (limit === 1) {
            if (state.wishes.length >= 3 && state.wishes[1].c !== state.wishes[2].c) {
                fail = true; msg = `âš ï¸ ç¬¬ 1 å¿—é¡˜åé¡åƒ… 1 å€‹ï¼Œæ‰£é™¤å¾Œï¼Œé¤˜ä¸‹ã€Œç¬¬ 2ã€3 å¿—é¡˜ã€é ˆç‚ºåŒä¸€è·ç¾¤ï¼`;
                items[1].classList.add('err-active');
                items[2].classList.add('err-active');
            }
        }

        if (state.fourth) {
            for (let i = 0; i < Math.min(3, state.wishes.length); i++) {
                if (state.wishes[i].c === state.fourth) {
                    fail = true; msg = "âš ï¸ åŠ é¸çš„ç¬¬ 4 è·ç¾¤ä¸å¯æ’åœ¨å‰ 3 å¿—é¡˜ï¼";
                    items[i].classList.add('err-active'); break;
                }
            }
        }

        if (fail) {
            errBox.innerText = msg;
            errBox.style.display = 'block';
            return false;
        }
        return true;
    }

    // --- å ±è¡¨ç”Ÿæˆèˆ‡è¼¸å‡º ---
    window.appGenerateReport = function() {
        try {
            const s = document.getElementById('inpStudent').value.trim();
            const p = document.getElementById('inpParent').value.trim();
            if (!s || !p) { alert("è«‹è¼¸å…¥å­¸ç”Ÿèˆ‡å®¶é•·å§“åï¼"); return; }
            
            const totalAvail = state.currentTotalAvailable || 0;
            if (totalAvail >= 15 && state.wishes.length < 15) {
                alert(`å…±æœ‰ ${totalAvail} å€‹å¿—é¡˜å¯é¸ï¼Œè«‹è‡³å°‘é¸å¡« 15 å€‹ï¼`); return;
            }
            if (totalAvail < 15 && state.wishes.length < totalAvail) {
                alert(`åƒ…æœ‰ ${totalAvail} å€‹å¿—é¡˜å¯é¸ï¼Œè«‹å…¨éƒ¨å‹¾é¸ï¼`); return;
            }

            if (!validateRules()) { 
                alert("å¿—é¡˜æ’åºæœ‰èª¤ï¼Œè«‹ä¿®æ­£ï¼");
                document.getElementById('msgError').scrollIntoView({behavior:'smooth'});
                return; 
            }

            document.getElementById('outStudent').innerText = s;
            document.getElementById('outParent').innerText = p;
            const d = new Date();
            document.getElementById('outDate').innerText = `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`;
            
            let cList = state.clusters.join('ã€');
            if (state.fourth) cList += ` (å«åŠ é¸ï¼š${state.fourth})`;
            document.getElementById('outClusters').innerText = cList;

            const tbody = document.getElementById('rptBody');
            tbody.innerHTML = '';
            state.wishes.forEach((w, i) => {
                const tr = document.createElement('tr');
                const colorMap = {
                    'bg-academic': '#e3f2fd', 'bg-machine': '#e0f7fa', 'bg-power': '#e8f5e9',
                    'bg-electro': '#fffde7', 'bg-business': '#f3e5f5', 'bg-design': '#fce4ec',
                    'bg-home': '#f3e5f5', 'bg-hosp': '#fff3e0', 'bg-food': '#e0f2f1',
                    'bg-agri': '#f1f8e9', 'bg-service': '#e8eaf6', 'bg-chem': '#e1f5fe'
                };
                if(colorMap[w.cls]) tr.style.backgroundColor = colorMap[w.cls];

                const badge = w.is4 ? ' <span class="badge-fourth">åŠ é¸</span>' : '';
                tr.innerHTML = `
                    <td style="text-align:center;font-weight:bold;">${i+1}</td>
                    <td style="text-align:center;">${w.c}</td>
                    <td><span style="font-weight:bold;">${w.s}</span><br>${w.d}${badge}</td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('pageForm').style.display = 'none';
            document.getElementById('reportContainer').style.display = 'block';
            document.getElementById('pageReport').style.display = 'block'; 
            window.scrollTo(0, 0);

        } catch (e) { alert("éŒ¯èª¤ï¼š" + e.message); }
    };

    window.appGoBack = function() {
        document.getElementById('reportContainer').style.display = 'none';
        document.getElementById('pageForm').style.display = 'block';
        window.scrollTo(0, 0);
    };

    function getReportText() {
        const s = document.getElementById('outStudent').innerText;
        let txt = `115å­¸å¹´åº¦ é©æ€§è¼”å°å®‰ç½® - å¿—é¡˜é¸å¡«ç¢ºèªè¡¨ (å‹åˆ©åœ‹ä¸­æ¨¡æ“¬)\n`;
        txt += `========================================\n`;
        txt += `å­¸ç”Ÿï¼š${s}\n`;
        txt += `å®¶é•·ï¼š${document.getElementById('outParent').innerText}\n`;
        txt += `è·ç¾¤ï¼š${document.getElementById('outClusters').innerText}\n`;
        txt += `========================================\n`;
        state.wishes.forEach((w, i) => {
            const n = w.is4 ? " [åŠ é¸]" : "";
            txt += `ç¬¬ ${i+1} å¿—é¡˜ï¼š${w.s} - ${w.d} (${w.c})${n}\n`;
        });
        return txt;
    }

    window.appCopyTxt = function() {
        try {
            const txt = getReportText();
            navigator.clipboard.writeText(txt).then(() => {
                alert("âœ… å·²è¤‡è£½å¿—é¡˜æ–‡å­—ï¼\nè«‹ç›´æ¥è²¼ä¸Š (Ctrl+V) åˆ†äº«çµ¦è€å¸«æˆ–å®¶é•·ã€‚");
            }).catch(err => {
                alert("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•ä¸‹è¼‰æ–‡å­—æª”ã€‚");
            });
        } catch (e) {
            alert("ç€è¦½å™¨ä¸æ”¯æ´ä¸€éµè¤‡è£½ï¼Œè«‹ä½¿ç”¨ä¸‹è¼‰æ–‡å­—æª”åŠŸèƒ½ã€‚");
        }
    };

    window.appDownloadTxt = function() {
        try {
            const txt = getReportText();
            const s = document.getElementById('outStudent').innerText;
            const blob = new Blob([txt], { type: "text/plain;charset=utf-8" });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `${s}_å¿—é¡˜è¡¨.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        } catch(e) { alert("ä¸‹è¼‰å¤±æ•—"); }
    };

    window.appSaveImage = function() {
        var div = document.getElementById('pageReport');
        var originalWidth = div.style.width;
        div.style.width = "850px"; 

        var btns = document.querySelector('.btn-zone.no-print');
        btns.style.display = 'none'; 

        if (window.html2canvas) {
            html2canvas(div, { 
                scale: 3, 
                backgroundColor: "#ffffff",
                windowWidth: 1200, 
                scrollY: -window.scrollY,
                useCORS: true
            }).then(function(canvas) {
                btns.style.display = 'block'; 
                var imgUrl = canvas.toDataURL("image/jpeg");
                var modal = document.createElement('div');
                modal.className = 'img-modal';
                modal.innerHTML = `
                    <div class="modal-tip">ğŸ‘† è«‹é•·æŒ‰åœ–ç‰‡ -> åŠ å…¥ç…§ç‰‡/ä¸‹è¼‰åœ–ç‰‡</div>
                    <img src="${imgUrl}">
                    <button class="modal-close" onclick="this.parentElement.remove()">é—œé–‰è¦–çª—</button>
                `;
                document.body.appendChild(modal);
                div.style.width = originalWidth;
            }).catch(function(err) {
                btns.style.display = 'block';
                div.style.width = originalWidth;
                alert("æˆªåœ–å¤±æ•—");
            });
        }
    };
</script>

</body>
</html>

